# Notification Service

`django` `djangorestframework`

## Общее описание

Проект представляет из себя реализацию API с использованием `django` и `djangorestframework` для
мониторинга курсов, групп, а также пользователей. В качестве БД используется `SQLite`.

### Архитектура БД

Таблицы/Модели:

- `Product`, `Group`, `User`, `Lesson` - для хранения информации о курсах, группах, пользователях и занятиях
  соответственно
- `Productmembership`, `Groupmembership` - для реализации отношения ManyToMany, хранения и эффективного получения
  информации о принадлежности пользователей к курсам и группам соответственно

### Пакетный менеджер
В качестве пакетного менеджера используется `poetry`. Все зависимости указаны в файле `pyproject.toml`.

### Описание процесса добавления пользователя к продукту и распределения пользователей по группам

При добавлении пользователя к продукту:

1. Проверяются корректность id продукта и id пользователя, проверка на то,
   что пользователь уже не принадлежит к продукту, после чего добавление поля в таблицу `Productmembership`.
2. Проверяется наличие групп в продукте, если их нет, то создается новая группа и пользователь добавляется в нее.
3. Если группы есть, то рассматривается количество участников в группе с наименьшим количеством участников данного
   продукта:

   - Если количество участников в группе меньше максимально допустимого, то пользователь добавляется в эту группу.
   - Если количество участников в группе равно максимально допустимому, то создается новая группа и пользователь
     добавляется в нее,
     после чего происходит перераспределение пользователей по группам, чтобы количество участников в группах было
     равномерным.

4. Добавляется запись в таблицу `Groupmembership`

Кроме того, реализация полей для хранения информации о максимальном и минимальном количестве пользователей 
в группе для каждого продукта хранится в качестве `property` в модели `Product`, что позволяет вызывать функцию для
перераспределение пользователей по группам после изменения этих значений.

**Таким образом, поддерживается инвариант, что количество пользователей по группам распределены равномерно.**

## API Endpoints

BASE_URL = `http://127.0.0.1:8000/`

### Продукты

- **Добавление пользователя к продукту**\
  - url:
    - `POST products/api/add_user_to_product/<int:user_id>/<int:product_id>`\
  - Коды ответов:
    - 200 - пользователь успешно добавлен к продукту
    - 403 - пользователь уже принадлежит к продукту или текущее время больше времени старта продукта
    - 404 - пользователь или продукт не найдены

- **Получение информации о доступных для покупки продуктах**\
  - url: 
    - `GET products/api/get_available_products`
  - Коды ответов:
    - 200 - список доступных продуктов
  - Возвращаемые данные:
    - список продуктов с их атрибутами

- **Получение доступных в рамках продукта уроков для клиента**
- url:
  - `GET products/api/get_product_lessons/<int:user_id>/<int:product_id>`
  - Коды ответов:
    - 200 - список доступных уроков
    - 403 - пользователь не имеет доступа к продукту
    - 404 - пользователь или продукт не найдены
  - Возвращаемые данные:
    - список уроков с ссылкой на просмотр

- **Получение общей статистики по продуктам**
- url:
  - `GET products/api/get_products_statistics`
  - Коды ответов:
    - 200 - статистика успешно получена
  - Возвращаемые данные:
    - список продуктов с информацией о количестве участников, проценте заполненности групп и т.д и проценте приобретения продукта


### Примеры взаимодействия с API

#### Добавление пользователя к продукту

Добавим пользователя с id=2 к продукту с id=3

```python
import requests

url = 'http://127.0.0.1:8000/products/api/add_user_to_product/2/3'

response = requests.post(url)
print(response.status_code)
```

#### Получение информации о доступных для покупки продуктах

```python
import requests
import json

url = 'http://127.0.0.1:8000/products/api/get_available_products'

response = requests.get(url)
if response.status_code == 200:
    print(json.loads(response.text))
```
Пример ответа:
```json
[
  {
    "product 2": {
      "author": "author 2",
      "lessons_number": 2,
      "name": "product 2",
      "price": 200.0,
      "start_time": "2024-03-03T13:45:17.324088Z"
    },
    "product 3": {
      "author": "author 3",
      "lessons_number": 1,
      "name": "product 3",
      "price": 300.0,
      "start_time": "2024-03-04T13:45:17.324092Z"
    }
  }
]
```

#### Получение доступных в рамках продукта уроков для клиента

```python
import requests
import json

url = 'http://127.0.0.1:8000/products/api/get_product_lessons/3/2'

response = requests.get(url)
if response.status_code == 200:
    print(json.loads(response.text))
```
Пример ответа:
```json
[
  {
    "lesson 1": {
      "name": "lesson 1",
      "url": "https://www.youtube.com/watch?v=dQw4w9WgXcQ"
    },
    "lesson 2": {
      "name": "lesson 2",
      "url": "https://www.youtube.com/watch?v=dQw4w9WgXcQ"
    }
  }
]
```

#### Получение общей статистики по продуктам

```python
import requests
import json

url = 'http://127.0.0.1:8000/products/api/get_products_statistics'

response = requests.get(url)
if response.status_code == 200:
    print(json.loads(response.text))
```
Пример ответа:
```json
[
  {
    "product 3": {
      "average_group_occupation": 100.0,
      "product_selling": 100.0,
      "students_number": 1
    },
    "product 4": {
      "average_group_occupation": 77.77777777777779,
      "product_selling": 100.0,
      "students_number": 7
    }
  }
]
```

